{% extends "layout.html" %}
{% block content %}
<h1>Загрузка видео</h1>
{% if not account %}
  <p>Добавьте аккаунт и канал в разделе «Настройки аккаунтов», чтобы начать загрузку.</p>
{% else %}
  {% if not channels %}
    <p>Для активного аккаунта нет каналов. Создайте канал на вкладке «Настройки аккаунтов».</p>
  {% else %}
  <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="card">
    <div class="form-row">
      <label for="channel_id">Канал</label>
      <select name="channel_id" id="channel_id" required>
        <option value="" disabled selected>Выберите канал</option>
        {% for channel in channels %}
        <option value="{{ channel.id }}">{{ channel.name }} ({{ channel.timezone }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-row">
      <label>Видео</label>
      <input type="file" name="video" required>
    </div>
    <div class="form-row">
      <label>Миниатюра</label>
      <input type="file" name="thumb">
    </div>
    <div class="form-row">
      <label>Title</label>
      <input name="title" placeholder="по умолчанию = имя файла">
    </div>
    <div class="form-row">
      <label for="template_id">Шаблон описания</label>
      <select name="template_id" id="template_id" required data-template-select>
        <option value="" disabled selected>Выберите шаблон</option>
        {% for template in templates %}
        <option value="{{ template.id }}" data-default-context='{{ template.default_context | tojson if template.default_context else '' }}'>{{ template.name }}</option>
        {% endfor %}
      </select>
      {% if not templates %}
      <p class="hint">Создайте шаблон в разделе «Шаблоны».</p>
      {% endif %}
    </div>
    <div class="form-row">
      <label for="template_context">Контекст (JSON)</label>
      <textarea name="template_context" id="template_context" rows="4" placeholder='{"title": "Видео"}' data-template-context></textarea>
      <button type="button" class="button-secondary" data-template-preview-button data-template-select="#template_id" data-context-field="#template_context" data-preview-target="#template-preview">Предпросмотр</button>
      <pre id="template-preview" class="template-preview" aria-live="polite"></pre>
    </div>
    <fieldset class="form-row tag-fieldset">
      <legend>Дополнительные теги</legend>
      <p class="hint">Теги шаблона объединяются с выбранными значениями. Лимит — {{ MAX_TAGS }} тегов.</p>
      {% if quick_tags %}
        {% for category, group in quick_tags | groupby('category') %}
        {% set items = group.list %}
        <div class="tag-group">
          <strong>{{ category or 'Без категории' }}</strong>
          <div class="tag-chips">
            {% for tag in items %}
            <label class="chip">
              <input type="checkbox" name="tag_ids" value="{{ tag.id }}">
              <span>{{ tag.tag }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="hint">Добавьте быстрые теги в разделе «Шаблоны».</p>
      {% endif %}
      <input name="custom_tags" placeholder="Дополнительные теги через запятую">
    </fieldset>
    <div class="form-row">
      <label>CategoryId</label>
      <input name="categoryId" value="22">
    </div>
    <fieldset class="form-row">
      <legend>Публикация</legend>
      <label><input type="radio" name="mode" value="now" checked> Сразу (public)</label>
      <label><input type="radio" name="mode" value="schedule"> Запланировать</label>
      <input type="date" name="date">
      <input type="time" name="time">
      <label><input type="radio" name="mode" value="random"> Рандом</label>
      Мин: <input type="number" step="0.1" name="min_h" value="1">
      Макс: <input type="number" step="0.1" name="max_h" value="3">
    </fieldset>
    <div class="form-actions">
      <button type="submit">Добавить в очередь</button>
    </div>
  </form>
  {% endif %}
{% endif %}

<section class="card">
  <h2>Очередь активного аккаунта</h2>
  {% if queue %}
  <table class="queue-table">
    <thead>
      <tr>
        <th>Название</th>
        <th>Канал</th>
        <th>Публикация</th>
        <th>Статус</th>
      </tr>
    </thead>
    <tbody>
      {% for item in queue %}
      <tr>
        <td>{{ item.title }}</td>
        <td>{{ item.channel.name }}</td>
        <td>
          {% if item.publish_at %}
            {{ (item.publish_at|in_tz(item.channel.timezone)).strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            Немедленно
          {% endif %}
        </td>
        <td>{{ item.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>Очередь пуста.</p>
  {% endif %}
  <form action="{{ url_for('start') }}" method="post">
    <button type="submit">Старт загрузки (всё из очереди)</button>
  </form>
</section>
<script src="{{ url_for('static', filename='templates.js') }}" defer></script>
{% endblock %}
