{% extends "layout.html" %}
{% block content %}
<h1>Загрузка видео</h1>
{% if not account %}
  <p>Добавьте аккаунт и канал в разделе «Настройки аккаунтов», чтобы начать загрузку.</p>
{% else %}
  {% if not channels %}
    <p>Для активного аккаунта нет каналов. Создайте канал на вкладке «Настройки аккаунтов».</p>
  {% else %}
  <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="card">
    <div class="form-row">
      <label for="channel_id">Канал</label>
      <select name="channel_id" id="channel_id" required>
        <option value="" disabled selected>Выберите канал</option>
        {% for channel in channels %}
        <option value="{{ channel.id }}">{{ channel.name }} ({{ channel.timezone }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-row">
      <label>Видео</label>
      <input type="file" name="video" required>
    </div>
    <div class="form-row">
      <label>Миниатюра</label>
      <input type="file" name="thumb">
    </div>
    <div class="form-row">
      <label>Title</label>
      <input name="title" placeholder="по умолчанию = имя файла">
    </div>
    <div class="form-row">
      <label>Description</label>
      <textarea name="description" rows="4"></textarea>
    </div>
    <div class="form-row">
      <label>Telegram ссылка</label>
      <input name="tg" placeholder="https://t.me/your_channel">
    </div>
    <div class="form-row">
      <label>Tags (через запятую)</label>
      <input name="tags" value="youtube,shorts">
    </div>
    <div class="form-row">
      <label>CategoryId</label>
      <input name="categoryId" value="22">
    </div>
    <fieldset class="form-row">
      <legend>Публикация</legend>
      <label><input type="radio" name="mode" value="now" checked> Сразу (public)</label>
      <label><input type="radio" name="mode" value="schedule"> Запланировать</label>
      <input type="date" name="date">
      <input type="time" name="time">
      <label><input type="radio" name="mode" value="random"> Рандом</label>
      Мин: <input type="number" step="0.1" name="min_h" value="1">
      Макс: <input type="number" step="0.1" name="max_h" value="3">
    </fieldset>
    <div class="form-actions">
      <button type="submit">Добавить в очередь</button>
    </div>
  </form>
  {% endif %}
{% endif %}

<section class="card">
  <h2>Очередь активного аккаунта</h2>
  {% if queue %}
  <table class="queue-table">
    <thead>
      <tr>
        <th>Название</th>
        <th>Канал</th>
        <th>Публикация</th>
        <th>Статус</th>
      </tr>
    </thead>
    <tbody>
      {% for item in queue %}
      <tr>
        <td>{{ item.title }}</td>
        <td>{{ item.channel.name }}</td>
        <td>
          {% if item.publish_at %}
            {{ (item.publish_at|in_tz(item.channel.timezone)).strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            Немедленно
          {% endif %}
        </td>
        <td>{{ item.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>Очередь пуста.</p>
  {% endif %}
  <form action="{{ url_for('start') }}" method="post">
    <button type="submit">Старт загрузки (всё из очереди)</button>
  </form>
</section>
{% endblock %}
